package io.kotest.examples.android

import androidx.compose.material3.Button
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithText
import io.kotest.core.spec.style.FreeSpec
import io.kotest.core.test.TestScope
import io.kotest.runner.junit4.KotestTestRunner
import io.kotest.runner.junit4.describeTestCase
import kotlinx.coroutines.runBlocking
import org.junit.rules.TestRule
import org.junit.runner.RunWith
import org.junit.runners.model.Statement

/**
 * Instrumented test using Kotest, which will execute on an Android device.
 *
 * Instrumented tests run on an Android device, either physical or emulated.
 * The app is built and installed alongside a test app that injects commands and reads the state.
 * Instrumented tests are usually UI tests, launching an app and then interacting with it.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(KotestTestRunner::class)
class ComposeWithKotest : FreeSpec() {
   init {
      "should have initial state of 0" {
         withRule(createComposeRule()) { composeTestRule ->

            composeTestRule.setContent {
               TestComposable()
            }

            composeTestRule.onNodeWithText("0").assertExists()
            composeTestRule.onNodeWithText("Click me!").assertExists()
         }
      }
      "should increment when clicked" {
         withRule(createComposeRule()) { composeTestRule ->

            composeTestRule.setContent {
               TestComposable()
            }

            composeTestRule.onNodeWithText("0").assertExists()
            composeTestRule.onNodeWithText("Click me!").assertExists()
         }
      }
   }
}

fun <R : TestRule> TestScope.withRule(rule: R, fn: suspend (rule: R) -> Unit) {
   val base = object : Statement() {
      override fun evaluate() {
         runBlocking { fn.invoke(rule) }
      }
   }
   rule.apply(base, describeTestCase(this.testCase, testCase.name.name)).evaluate()
}

/**
 * Simple composable which has a counter and a button that will increase the counter
 * each time it is clicked.
 */
@Composable
private fun TestComposable() {
   var counter by remember { mutableStateOf(0) }
   Button(onClick = { counter++ }) { Text("Click me!") }
   Text(counter.toString())
}
